name: Trigger deployment

on:
  workflow_dispatch:
    inputs:
      sha:
        description: "Target image sha (default to latest commit on branch)"
        required: true

env:
  TARGET_SHA: ${{ github.sha }}

jobs:
  print-inputs:
    name: Print workflow dispatch inputs
    runs-on: ubuntu-latest
    steps:
      - name: Echo inputs.
        run: |
          echo 'Ref: ${{ github.ref }}'
          echo 'Inputs: ${{ toJSON(github.event.inputs) }}'

  trigger-deploy:
    name: trigger on dev
    runs-on: ubuntu-latest
    steps:
      - name: set ref SHA
        if: github.event.inputs.sha
        run: echo "TARGET_SHA=${{ github.event.inputs.sha }}" >> $GITHUB_ENV

      - name: trigger deployment to dev
        run: |
          curl -X POST \
              ${{ github.event.repository.deployments_url }} \
              -H 'Authorization: Bearer ${{ secrets.PERSONAL_ACCESS_TOKEN  }}' \
              -H 'Content-Type: application/json' \
              -H 'cache-control: no-cache' \
              -d '{
                "ref": "${{github.sha}}",
                "required_context": [],
                "environment": "dev",
                "auto_merge": false,
                "payload":{
                  "name": "dev",
                  "target-image": "${{ env.TARGET_SHA }}"
                }
              }'
